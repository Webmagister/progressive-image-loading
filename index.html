<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Progressive Image Loading</title>
    <link rel="stylesheet" href="main.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500" rel="stylesheet">
</head>
<body>
<figure>
    <div class="aspectRatioPlaceholder">
        <div class="aspect-ratio-fill"></div>
        <div class="progressiveMedia js-progressiveMedia" data-width="1920" data-height="1279" data-scroll="native">
            <img src="https://cdn-images-1.medium.com/freeze/max/30/1*2wEdXudz3A_hXWepB3xHaw.jpeg?q=20"
                 class="progressiveMedia-thumbnail">
            <canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas>
            <img class="progressiveMedia-image js-progressiveMedia-image"
                 data-src="https://cdn-images-1.medium.com/max/2000/1*2wEdXudz3A_hXWepB3xHaw.jpeg"
                 src="">
        </div>
    </div>
</figure>
<figure>
    <div class="aspectRatioPlaceholder">
        <div class="aspect-ratio-fill"></div>
        <div class="progressiveMedia js-progressiveMedia" data-width="700" data-height="394">
            <img src="https://cdn-images-1.medium.com/freeze/max/30/0*4q74mYwYhitaBOb1.jpg?q=20"
                 class="progressiveMedia-thumbnail">
            <canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas>
            <img class="progressiveMedia-image js-progressiveMedia-image"
                 data-src="https://cdn-images-1.medium.com/max/800/0*4q74mYwYhitaBOb1.jpg"
                 src="">
        </div>
    </div>
</figure>
<figure>
    <div class="aspectRatioPlaceholder">
        <div class="aspect-ratio-fill"></div>
        <div class="progressiveMedia js-progressiveMedia" data-width="696" data-height="427">
            <img src="https://cdn-images-1.medium.com/freeze/max/30/0*PhhFM5NfWLiCg2ee.jpg?q=20"
                 class="progressiveMedia-thumbnail">
            <canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas>
            <img class="progressiveMedia-image js-progressiveMedia-image"
                 data-src="https://cdn-images-1.medium.com/max/800/0*PhhFM5NfWLiCg2ee.jpg"
                 src="">
        </div>
    </div>
</figure>


<script>
    [].forEach.call(document.querySelectorAll('div.js-progressiveMedia'), function (elem)
    {
        var maxWidth = elem.getAttribute('data-width');
        var maxHeight = elem.getAttribute('data-height');
        var aspectRatio = ((maxHeight / maxWidth) * 100).toFixed(1);
        elem.previousSibling.previousSibling.setAttribute('style', 'padding-bottom:' + aspectRatio + '%;');
        elem.parentNode.setAttribute('style', 'max-width:' + maxWidth + 'px; max-height:' + maxHeight + 'px;');

        var canvas = elem.getElementsByTagName('canvas')[0];
        var pic = new Image();
        pic.src = elem.getElementsByTagName('img')[0].getAttribute('src');
        var ctx = canvas.getContext('2d');

        var canvasWidth;
        var canvasHeight;
        if (maxWidth > maxHeight)
        {
            canvasWidth = 75;
            canvasHeight = maxHeight / (maxWidth / 75);
        }
        else
        {
            canvasHeight = 75;
            canvasWidth = maxWidth / (maxHeight / 75);
        }
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        pic.onload = function ()
        {

            ctx.filter = 'blur(5px)';
            canvas.parentNode.classList.add('is-canvasLoaded');
            ctx.drawImage(this, -10, -10, canvasWidth + 20, canvasHeight + 20);
        }
    });
    [].forEach.call(document.querySelectorAll('img[data-src]'), function (img)
    {
        img.setAttribute('src', img.getAttribute('data-src'));
        img.onload = function ()
        {
            img.removeAttribute('data-src');
            img.parentNode.classList.add('is-imageLoaded');
        };
    });
</script>
</body>
</html>